{% extends "base.html" %}
{% block title %}Transactions{% endblock %}

{% block content %}
<div class="container mt-5">
  <h2 class="mb-4">Transactions for {{ current_user.name }} ({{ current_user.username }})</h2>

  <!-- Filter Form -->
  <form method="GET" class="filter-form mb-4">
    <label for="name">Search by Name:</label>
    <input type="text" name="name" id="name" placeholder="Beneficiary Name" value="{{ request.args.get('name', '') }}">

    <label for="start_date">Start Date:</label>
    <input type="date" name="start_date" id="start_date" value="{{ request.args.get('start_date', '') }}">

    <label for="end_date">End Date:</label>
    <input type="date" name="end_date" id="end_date" value="{{ request.args.get('end_date', '') }}">

    <button type="submit" class="btn btn-primary btn-sm">Filter</button>
    <a href="{{ url_for('main.transactions') }}" class="btn btn-secondary btn-sm">Reset</a>
  </form>

  {% if transactions %}
  <table class="table table-striped table-bordered">
    <thead class="table-primary">
      <tr>
        <th>Transaction ID</th>
        <th>Type</th>
        <th>Amount (₹)</th>
        <th>Recipient Account</th>
        <th>Date</th>
        <th>Status</th>
        <th>Report</th>
      </tr>
    </thead>
    <tbody>
      {% for tx in transactions %}
      <tr>
        <td>{{ "TNX" + tx.timestamp.strftime('%Y%m%d') + ("%04d"|format(tx.id)) }}</td>
        <td>{{ tx.type }}</td>
        <td>₹{{ tx.amount }}</td>
        <td>{{ tx.recipient_account or '-' }}</td>
        <td>{{ tx.timestamp.strftime('%Y-%m-%d %H:%M:%S') if tx.timestamp else 'N/A' }}</td>
        <td>
          {% if tx.status %}
            {% if tx.status.lower() == 'success' %}
              <span class="badge bg-success">{{ tx.status }}</span>
            {% elif tx.status.lower() == 'failed' %}
              <span class="badge bg-danger">{{ tx.status }}</span>
            {% else %}
              <span class="badge bg-secondary">{{ tx.status }}</span>
            {% endif %}
          {% else %}
            <span class="text-muted">-</span>
          {% endif %}
        </td>
        <td>
          {% if tx.id in reported_ids %}
          <form method="POST" action="{{ url_for('main.undo_report_transaction', transaction_id=tx.id) }}">
            <button type="submit" class="btn btn-warning btn-sm">Undo Report</button>
          </form>
          {% else %}
          <form method="POST" action="{{ url_for('customer.report_transaction', transaction_id=tx.id) }}">
            <input type="text" name="reason" placeholder="Reason (optional)" class="form-control mb-1">
            <button type="submit" class="btn btn-danger btn-sm">Report</button>
          </form>
          {% endif %}
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  {% else %}
    <p class="text-muted">No transactions found.</p>
  {% endif %}

  <!-- Back Button -->
  <a href="{{ url_for('main.dashboard') }}" class="btn btn-secondary mt-4">Back to Dashboard</a>

  {% if saved_contacts %}
  <hr>
  <h3>Recent Recipients</h3>
  <ul>
    {% for contact in saved_contacts %}
      <li>
        <button type="button" onclick="prefillTransfer('{{ contact.name }}', '{{ contact.account_number }}')">
          <img src="{{ url_for('static', filename='img/user-icon.png') }}" width="30">
          {{ contact.name }} ({{ contact.account_number }})
        </button>
      </li>
    {% endfor %}
  </ul>
  {% endif %}
</div>

<script>
  function prefillTransfer(name, accNo) {
    if (document.getElementById('beneficiary_name') && document.getElementById('account_number')) {
      document.getElementById('beneficiary_name').value = name;
      document.getElementById('account_number').value = accNo;
    }
  }
</script>
{% endblock %}
